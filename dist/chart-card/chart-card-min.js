/**
 * License: MIT
 * Generated on 2020
 * Author: Peter siebler
 */

import"/hacsfiles/chart-card/libs/chart.js?module";import"/hacsfiles/chart-card/libs/chartjs-plugin-autocolors.min.js";import"/hacsfiles/chart-card/libs/chartjs-plugin-gradient.min.js";const gradient=window["chartjs-plugin-gradient"],autocolors=window["chartjs-plugin-autocolors"],CHARTJSv3=!0;console.info("%c CHARTJS-CARD-DEV %c ".concat("0.0.4"," "),"color: white; background: #2980b9; font-weight: 700;","color: white; background: #e74c3c; font-weight: 700;");let GLOBAL={LOCALE:""};const dtFormat=function(t){const e=[];return e.timestamp="timestamp",e.day="%Y-%M-%d",e.hour="%Y-%M-%d %H:00:00",e.month="%Y-%M",e.year="%Y",t in e?e[t]:e.timestamp};class ChartCard extends HTMLElement{static get properties(){return{_config:{},_hass:{}}}constructor(){super(),this._hass=null,this.attachShadow({mode:"open"}),this.card_icon=null,this.card_title=null,this.card_height=240,this.theme="",this.themeSettings=null,this.graphChart=null,this.chart_type="bar",this.chart_locale="de-DE",this.chart_update=!1,this.ctx=null,this.chartconfig=null,this.graphData={},this.hassEntities=[],this.entities=[],this.entity_ids=[],this.entityData=[],this.entityNames=[],this.updateInterval=60,this.data_hoursToShow=0,this.data_group_by="day",this.data_dateGroup=null,this.data_ignoreZero=!1,this.data_units="",this.startTime=new Date,this.lastEndTime=new Date,this.skipRender=!1,this.ready=!1,this._initialized=!1}_evaluateCssVariable(t){try{return getComputedStyle(document.documentElement).getPropertyValue(t).trim()}catch(e){console.log("ERROR evaluateCssVariable:",t,"ERROR",e)}return t}_getThemeSettings(){this.themeSettings={fontColor:this._evaluateCssVariable("--primary-text-color")||"#333333",fontFamily:this._evaluateCssVariable("--paper-font-common-base_-_font-family")||"Quicksand, Roboto,'Open Sans','Rubik','Helvetica Neue', 'Helvetica', 'Arial', sans-serif",gridlineColor:this._evaluateCssVariable("--light-primary-color")||"#DCDCDC",zeroLineColor:this._evaluateCssVariable("--dark-primary-color")||"#555555",tooltipsBackground:"#ecf0f1",tooltipsFontColor:"#647687",showLegend:["pie","doughnut","polarArea","line"].includes(this.chart_type.toLowerCase()),showGridLines:["bar","line"].includes(this.chart_type.toLowerCase()),useAutoColors:!0}}_setChartConfig(){let t={};if(t.type=this.chart_type,this._config.options&&(t.options={},t.options=this._config.options),this.chartconfig=t,this._getThemeSettings(),this.ctx){let t={ctx:this.ctx,chart_locale:this.chart_locale,chart_type:this.chart_type,themeSettings:this.themeSettings,chartconfig:this.chartconfig};this.graphChart=new graphChart(t)}else console.error("No chart.js container found !")}_creatHACard(){const t=Math.random().toString(36).substr(2,9);this.id="card-"+t;const e=document.createElement("ha-card"),a=document.createElement("div"),i=document.createElement("canvas");this.ctx=i.getContext("2d");const s=document.createElement("style");e.id=this.id,a.id="content-"+t,i.id="chart-"+t,a.style.height=this.card_height+"px",i.height=this.card_height;const r=document.createElement("div");if(r.setAttribute("class","card-header"),this.card_icon){const t=document.createElement("ha-icon");t.setAttribute("icon",this.card_icon),t.style.cssText="position:relative;top:-4px;padding:0 12px 0 4px;",r.appendChild(t)}if(this.card_title){const t=document.createElement("span");t.innerHTML="\x3c!----\x3e"+this.card_title+"\x3c!----\x3e",r.appendChild(t)}if((this.card_title||this.card_icon)&&e.append(r),this.card_info){const t=document.createElement("div");t.style="min-height:30px; background-color:trasnparent;padding:8px",e.appendChild(t)}e.appendChild(a),e.appendChild(s),a.appendChild(i),this.root.appendChild(e)}setConfig(t){if(!t.entities)throw new Error("You need to define an entity");try{this.root=this.shadowRoot,this.root.lastChild&&this.root.removeChild(this.root.lastChild),this._config=t,this.card_title=this._config.title||"",this.card_icon=this._config.icon||null,this.card_height=this._config.height||240,this.card_info=this._config.cardInfo||null,this.chart_type=this._config.chart||"bar";const e=["line","radar","bar","horizontalBar","pie","doughnut","polarArea","bubble","scatter"];if(!this.chart_type)throw new Error("You need to define type of chart");if(!e.includes(this.chart_type))throw new Error("Invalid config for 'chart'. Available options are: "+e.join(", "));this.chart_locale=GLOBAL.LOCALE=this.chart_locale||"de-DE",this.updateInterval=this._config.update||60,this.data_hoursToShow=this._config.hours_to_show||0,this.data_group_by=this._config.group_by||"day",this.data_dateGroup=dtFormat(this.data_group_by),this.data_aggregate=this._config.aggregate||"last",this.data_ignoreZero=this._config.ignoreZero||!1,this.data_units=this._config.units||"",this.data_test=this._config.testdata||null,this._creatHACard(),this._setChartConfig()}catch(e){console.log(e.message,t)}}set hass(t){if(!(void 0===t||this.theme&&this.theme!==t.selectedTheme&&(this.theme=t.selectedTheme,this._getThemeSettings(),this.graphChart&&(this.graphChart.themeSettings=this.themeSettings,this.graphChart.updateGraph()),this.skipRender))){if(this.updateInterval){if(((new Date).getTime()-this.startTime.getTime())/1e3>this.updateInterval&&(this.graphChart.themeSettings=this.themeSettings,this._getHistory(),this.startTime=new Date,this.skipRender))return}if(this.skipRender&&this.hassEntities&&this.hassEntities.length){let e=!1;this.hassEntities.forEach(a=>{e=e||Boolean(this.hass&&t.states[a]!==this._hass.states[a])}),e&&console.log("NEW DATA !!!!")}if(this._hass=t,this.theme=t.selectedTheme,this.hassEntities=this._config.entities.map(e=>t.states[e.entity]),this.hassEntities&&0!==this.hassEntities.length){if(this.entityData=this.hassEntities.map(t=>void 0===t?0:t.state),!1===this.ready&&this.entities.length!==this.hassEntities.length){this.entities=[];for(let t of this._config.entities){const e=this.hassEntities.find(e=>e.entity_id===t.entity);let a=Object.assign({},t);e.attributes&&(a.name=a.name||e.attributes.friendly_name||a.name,a.unit=a.unit||e.attributes.unit_of_measurement||""),e&&(a.last_changed=e.last_changed,a.state=e.state),this.entities.push(a),this.entity_ids.push(t.entity)}this.ready=0!==(this.entity_ids&&this.entity_ids.length)}this.entityNames=this._config.entities.map(e=>void 0!==e.name?e.name:void 0!==t.states[e.entity].attributes.friendly_name?t.states[e.entity].attributes.friendly_name:e.entity),0==this.skipRender&&(this._getHistory(),this.skipRender=!0)}}}_getHistory(){if(this.ready)if(this.data_hoursToShow&&this.data_hoursToShow>0){let t;this.chart_update?t=this.lastEndTime:(t=new Date).setHours(t.getHours()-this.data_hoursToShow);let e=new Date;this.lastEndTime=e;let a="history/period/"+(t.toISOString()+"?end_time="+e.toISOString()+"&filter_entity_id="+this.entity_ids.join(","))+"&minimal_response";this._hass.callApi("GET",a).then(t=>this._buildGraphData(t),()=>null)}else this._buildGraphData(null)}_buildGraphData(t){const e=new chartData({chart_type:this.chart_type,entities:this.entities,entityData:this.entityData,entityNames:this.entityNames,stateHistories:t,data_dateGroup:this.data_dateGroup,data_aggregate:this.data_aggregate});t&&t.length?this.graphData=e.getHistoryGraphData():this.graphData=e.getCurrentGraphData(),null!==this.graphData?(this.graphData.config&&(this.themeSettings.useAutoColors=this.graphData.config.useAutoColors),this.chart_update?this.graphChart&&this.graphData&&(this.graphChart.graphData=this.graphData,this.graphChart.updateGraph()):this.graphChart&&this.graphData&&(this.graphChart.graphData=this.graphData,this.graphChart.renderGraph())):console.error("No GraphData found for ",this.entityNames)}getCardSize(){return 4}}function formatDate(t,e){const a=new Date(t);function i(t){return t.toString().length<2?"0"+t:t}return"timestamp"==e?a.getUTCFullYear()+"-"+i(a.getUTCMonth()+1)+"-"+i(a.getUTCDate())+" "+i(a.getUTCHours())+":"+i(a.getUTCMinutes())+":"+i(a.getUTCSeconds()):e.replace(/%([a-zA-Z])/g,function(t,e){switch(e){case"Y":return a.getUTCFullYear();case"M":return i(a.getUTCMonth()+1);case"d":return i(a.getUTCDate());case"H":return i(a.getUTCHours());case"m":return i(a.getUTCMinutes());case"s":return i(a.getUTCSeconds());default:throw new Error("Unsupported format code: "+e)}})}function randomScalingFactor(){return(Math.random()>.5?1:-1)*Math.round(996.98*Math.random()*.52)}function reject(t,e){return Object.keys(t).filter(t=>!e.includes(t)).map(e=>Object.assign({},{[e]:t[e]})).reduce((t,e)=>Object.assign(t,e),{})}function num(t){return t===parseInt(t)?parseInt(t):parseFloat(t).toFixed(2)}customElements.define("chart-card",ChartCard);class chartData{constructor(t){this.chart_type=t.chart_type,this.entities=t.entities,this.entityData=t.entityData,this.entityNames=t.entityNames,this.stateHistories=t.stateHistories,this.data_dateGroup=t.data_dateGroup,this.data_aggregate=t.aggregate||"last",this.graphData={}}_getGroupHistoryData(t,e,a){try{let i={};return t.forEach(function(t){let a=formatDate(t.last_changed,e);i[a]=i[a]||[],t.timestamp=formatDate(t.last_changed,"timestamp"),t.last_changed=a,i[a].push(t)}),Object.keys(i).map(function(t){let e=i[t].filter(t=>!isNaN(parseFloat(t.state))&&isFinite(t.state));if("first"==a){const t=e.shift();return{y:num(t.state),x:t.last_changed}}if("last"==a){const t=e[e.length-1];return{y:num(t.state),x:t.last_changed}}if("max"==a)return e.reduce((t,e)=>t.state>e.state?{y:num(t.state),x:t.last_changed}:{y:num(e.state),x:e.last_changed});if("min"==a)return e.reduce((t,e)=>t.state<e.state?{y:num(t.state),x:t.last_changed}:{y:num(e.state),x:e.last_changed});if("sum"==a){const t=e.reduce((t,e)=>t+num(e.state),0);return{y:num(t),x:e[0].last_changed}}if("avg"==a){const t=e.reduce((t,e)=>t+num(e.state),0)/e.length;return{y:num(t),x:e[0].last_changed}}return e.map(t=>({y:num(t.state),x:t.timestamp}))})}catch(t){console.error("Build Histroydata",t.message)}}getTestData(t){let e=[],a={data:{labels:[],datasets:[]}};for(let i of t){e.push(i.name);let t=[],s=0,r=0,h=0;i.randomize&&(t=Array.apply(null,Array(parseInt(i.randomize))).map(function(){return parseFloat(randomScalingFactor()).toFixed(2)})),i.data&&(t=i.data.split(",").map(function(t){return+t})),i.value&&(t=parseFloat(i.value)),s=t.length?Math.min(...t):t,r=t.length?Math.max(...t):t,h=t.length?Math.floor(Math.random()*t.length):t;const n=reject(i,["name","data","value","randomize"]);let o={label:i.name,data:t,minval:s,maxval:r,current:h,borderWidth:3,hoverBorderWidth:0,pointRadius:0,fill:!0,pointRadius:0,mode:"testsensor"};a.data.labels=e,o={...o,...n},a.data.datasets.push(o)}return a}getCurrentGraphData(){try{const t=this.entityData.reduce((t,e,a)=>(0==e&&t.push(a),t),[]);let e=this.entityData.filter((e,a,i)=>!t.includes(a)),a=this.entityNames.filter((e,a,i)=>!t.includes(a));this.graphData={data:{labels:a,datasets:[{data:e,borderWidth:0,hoverBorderWidth:0,pointRadius:0,fill:!0,pointRadius:0,unit:this.data_units||"",mode:"current"}]}};let i=this.entities.map(t=>{if(void 0!==t.color||void 0!==t.backgroundColor)return t.color||t.backgroundColor}).filter(t=>void 0!==t);return i.length===this.graphData.data.labels.length&&(this.graphData.data.datasets[0].backgroundColor=i),0===this.graphData.data.length?void console.error("No Histroydata present !"):(this.graphData.config={useAutoColors:0==i.length},this.graphData)}catch(t){console.error("Current entities GraphData",t.message)}return null}getHistoryGraphData(){try{if(this.stateHistories&&this.stateHistories.length){let t={data:{labels:[],datasets:[]}};for(const e of this.stateHistories){const a=this._getGroupHistoryData(e,this.data_dateGroup,this.data_aggregate),i=e[0].entity_id,s=this.entities.find(t=>t.entity===i);let r=this.data_ignoreZero?a.map(t=>t.y).filter(t=>0!=t):a.map(t=>t.y),h={label:s.name||"unkonwn",borderWidth:3,hoverBorderWidth:0,fill:!1,unit:s.unit||"",data:r,minval:Math.min(...r),maxval:Math.max(...r),current:s.state||0,mode:"history"};t.data.labels=a.map(t=>t.x),s&&(h={...h,...s}),this.graphData.config={useAutoColors:!0},t.data.datasets.push(h)}return this.graphData=t,this.graphData}}catch(t){console.error("Build History GraphData",t.message)}return null}}function deepMerge(...t){let e={};for(const a of t)if(a instanceof Array)e instanceof Array||(e=[]),e=[...e,...a];else if(a instanceof Object)for(let[t,i]of Object.entries(a))i instanceof Object&&t in e&&(i=deepMerge(e[t],i)),e={...e,[t]:i};return e}class graphChart{constructor(t){this.ctx=t.ctx||null,this.chart=null,this.chart_locale=t.locale||"de-DE",this.chart_type=t.chart_type||"bar",this.themeSettings=t.themeSettings||{},this.chartconfig=t.chartconfig||{},this.graphData={},this.chart_update=!1,this.chart_ready=!1}_chartTooltips(t,e){const a=e.datasets[t.datasetIndex];let i="",s="";switch(this.chart_type.toLowerCase()){case"pie":case"doughnut":const r=a._meta[Object.keys(a._meta)[0]],h=a.data[t.index];if(i=e.labels[t.index]||"",s=a.unit||"",r.total){s+=" ("+parseFloat((h/r.total*100).toFixed(1))+"%)"}return" "+i+": "+a.data[t.index].toLocaleString()+" "+s;case"polararea":case"scatter":case"line":case"bar":case"radar":default:return i=a.label?a.label+": ":"",i+=e.labels[t.index]||"",s=a.unit||""," "+i+": "+a.data[t.index].toLocaleString()+" "+s}}_setChartOptions(){let t={charttype:this.chart_type,responsive:!0,maintainAspectRatio:!1,animation:{duration:0},units:this.data_units||"",title:{display:!1,fontStyle:"normal",text:"",fontSize:18},layout:{padding:{left:8,right:8,top:0,bottom:20}},chartArea:{backgroundColor:"transparent"},legend:{display:this.themeSettings.showLegend||!1,position:"bottom",lineWidth:0},tooltips:{enabled:!0,mode:"nearest",position:"nearest"},hover:{mode:"nearest",intersect:!0},elements:{point:{radius:.2,hitRadius:8}},plugins:{autocolors:{useAutoColors:!0,enabled:this.themeSettings.useAutoColors,mode:"data"}}};switch(this.chart_type.toLowerCase()){case"radar":CHARTJSv3&&Chart.defaults.set("radar.scales.r.ticks",{backdropColor:"transparent"});break;case"polararea":CHARTJSv3&&Chart.defaults.set("polarArea.scales.r.ticks",{backdropColor:"transparent"})}this.chartconfig.options?this.chartconfig.options=deepMerge(t,this.chartconfig.options):this.chartconfig.options=t}renderGraph(){try{if(this.chart&&this.chart_ready)return void this.updateGraph();this._setChartOptions(),this.chartconfig.data={labels:this.graphData.data.labels,datasets:this.graphData.data.datasets},this.ctx&&this.chartconfig.data.datasets&&this.chartconfig.options&&(CHARTJSv3&&(autocolors&&Chart.register(autocolors),gradient&&Chart.register(gradient)),this.chart=new Chart(this.ctx,this.chartconfig),this.chart&&(this.chart_ready=!0))}catch(t){console.error("Render Graph Error on ",this.chart_type,": ",t,this.chartconfig.options)}}updateGraph(){try{this.chart&&this.ctx&&this.chart_ready&&(this.chartconfig.data={charttype:this.chart_type,unit:this.data_units,labels:this.graphData.data.labels,datasets:this.graphData.data.datasets},this.chart.options=this.chartconfig.options,this.chart.data=this.chartconfig.data,this.chart.update({duration:0,easing:"linear"}),this.chart_update=!0)}catch(t){console.error("Update Graph",t.message,this.chartconfig.options)}}}